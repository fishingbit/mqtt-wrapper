<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="mqtt-wrapper">
    <script>
        /**
         * # This is an h1 heading
         * `<awesome-sauce>` injects a healthy dose of awesome into your page.
         * ## This is an h2 heading
         * In typical use, just slap some `<awesome-sauce>` at the top of your body:
         * <body>
         *   <awesome-sauce></awesome-sauce>
         * Wham! It's all awesome now!
         * @customElement
         * @polymer
         * @demo https://path/to/awesomeness/demo/
         *
         */
        class MqttWrapper extends Polymer.Element {
            static get is() { return 'mqtt-wrapper'; }
            static get properties() {
                return {

                    sub: {
                        type: Array,
                        observer: '__subChange'
                    },


                    pub: {
                        type: Array,
                        observer: '__pubChange'
                    },

                    noDisable: {
                        type: Boolean,
                        value: false,
                        observer: '__noDisableChange'
                    }
                }
            }

            connectedCallback() {
                this.__mqtt = document.querySelector('mqtt-connection');
                this.__child = this.querySelector('*:first-child');
                this.__eventHandlers = [];
                this.__subscriptions = [];

                super.connectedCallback();
            }

            __removeEventHandlers() {
                this.__eventHandlers.forEach(eh => {
                    this.__child.removeEventListener(eh.event, eh.handler);
                });
                this.__eventHandlers = [];
            }

            __addEventHandlers() {
                if (this.pub && this.pub.length > 0) {
                    this.pub.forEach(conf => {
                        const handler = () => {
                            if (typeof conf.payload !== 'undefined') {
                                this.__mqtt.publish(conf.topic, conf.payload);
                            } else if (typeof conf.attribute !== 'undefined') {
                                this.__mqtt.publish(conf.topic, this.__child[conf.attribute]);
                            }
                        };
                        this.__eventHandlers.push({event: conf.event, handler});
                        this.__child.addEventListener(conf.event, handler);
                    });
                }

            }

            __removeSubscriptions() {
                this.__subscriptions.forEach(sid => {
                    this.__mqtt.unsubscribe(sid);
                });
                this.__subscriptions = [];
            }

            __addSubscriptions() {
                if (this.sub && this.sub.length > 0) {
                    this.sub.forEach(conf => {
                        this.__subscriptions.push(this.__mqtt.subscribe(conf.topic, payload => {
                            if (typeof conf.disable !== 'undefined') {
                                if (this.__child[conf.disable]) {
                                    return;
                                }
                            }
                            if (typeof conf.json !== 'undefined' && payload.indexOf('{') !== -1) {
                                try {
                                    payload = JSON.parse(payload)[conf.json];
                                } catch (err) {
                                    console.error('json parse failed');
                                }
                            }
                            if (conf.negate) {
                                payload = !payload;
                            }
                            if (typeof conf.attribute !== 'undefined') {
                                if (conf.type === 'boolean' && !payload) {
                                    this.__child.removeAttribute(conf.attribute);
                                } else {
                                    this.__child.setAttribute(conf.attribute, payload);
                                }
                            } else if (conf.content === 'html') {
                                this.__child.innerHTML = payload;
                            } else if (conf.content === 'text') {
                                this.__child.textContent = payload;
                            }
                        }));
                    });
                }
            }

            refresh() {
                this.__removeEventHandlers();
                this.__removeSubscriptions();
                this.__child = this.querySelector('*:first-child');
                this.__addEventHandlers();
                this.__addSubscriptions();
            }

            __subChange() {
                this.__removeSubscriptions();
                this.__addSubscriptions();
            }

            __pubChange() {
                this.__removeEventHandlers();
                this.__addEventHandlers();
            }

            __noDisableChange() {
                if (!this.noDisable) {
                    this.__connectedChangeHandler = event => {
                        if (event.detail.value) {
                            this.__child.removeAttribute('disabled')
                        } else {
                            this.__child.setAttribute('disabled', true);
                        }
                    };
                    this.__mqtt.addEventListener('connected-changed', this.__connectedChangeHandler);
                } else {
                    if (this.__connectedChangeHandler) {
                        this.__mqtt.removeEventListener('connected-change', this.__connectedChangeHandler);
                    }
                }
            }
        }

        customElements.define(MqttWrapper.is, MqttWrapper);
    </script>
</dom-module>
